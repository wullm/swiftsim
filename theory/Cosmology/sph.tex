\subsubsection{SPH equations}

Using the SPH definition of density,
$\rho_i' = \sum_jm_jW(\mathbf{r}_{j}'-\mathbf{r}_{i}',h_i') =
\sum_jm_jW_{ij}'(h_i')$, we can follow \cite{Price2012} and apply the
Euler-Lagrange equations to write
\begin{alignat}{3}
  \dot{\mathbf{r}}_i'&= \frac{1}{a^2} \mathbf{v}_i'&  \label{eq:cosmo_eom_r} \\
  \dot{\mathbf{v}}_i' &= -\sum_j m_j &&\left[\frac{1}{a^{3(\gamma-1)}}f_i'A_i'\rho_i'^{\gamma-2}\mathbf{\nabla}_i'W_{ij}'(h_i)\right. \nonumber\\
  &   && + \left. \frac{1}{a^{3(\gamma-1)}}f_j'A_j'\rho_j'^{\gamma-2}\mathbf{\nabla}_i'W_{ij}'(h_j)\right. \nonumber\\
  &   && + \left. \frac{1}{a}\mathbf{\nabla}_i'\phi'\right] \label{eq:cosmo_eom_v}
\end{alignat}
with
\begin{equation}
    f_i' = \left[1 + \frac{h_i'}{3\rho_i'}\frac{\partial
      \rho_i'}{\partial h_i'}\right]^{-1}, \qquad \mathbf{\nabla}_i'
  \equiv \frac{\partial}{\partial \mathbf{r}_{i}'}. \nonumber
\end{equation}
These correspond to the equations of motion for density-entropy SPH
\citep[e.g. eq. 14 of][]{Hopkins2013} with cosmological and
gravitational terms. SPH flavours that evolve the internal energy $u$ instead of the
entropy require the additional equation of motion describing the evolution of
$u'$:
\begin{equation}
  \dot{u}_i' = \frac{1}{a^2}\frac{P_i'}{\rho_i'^2} f_i'\sum_jm_j\left(\mathbf{v}_i' -
    \mathbf{v}_j'\right)\cdot\mathbf{\nabla}_i'W_{ij}'(h_i).
  \label{eq:cosmo_eom_u}
\end{equation}
In all these cases, the scale-factors appearing as the first term on
the RHS of the equations are later absorbed in the time-integration
operators (Sec.~\ref{ssec:operators}) such that the RHS of the
equations of motions is identical for the primed quantities to the
ones obtained in the non-cosmological case for the physical
quantities.

Additional terms in the SPH equations of motion (e.g. viscosity
switches) often rely on the velocity divergence and curl. Their SPH
estimators $\langle\cdot\rangle$ in physical coordinates can be
related to their estimators based on our primed-coordinates using:
\begin{align}
  \left\langle \mathbf{\nabla}\cdot\dot{\mathbf{r}}_i \right\rangle &=
  \frac{1}{a^2} \left\langle
  \mathbf{\nabla}'\cdot\mathbf{v}_i'\right\rangle =
  \frac{1}{a^2\rho_i'}\sum_j m_j\left(\mathbf{v}_j' -
  \mathbf{v}_i'\right) \cdot \mathbf{\nabla}_i'W_{ij}'(h_i), \nonumber \\
  \left\langle \mathbf{\nabla}\times\dot{\mathbf{r}}_i \right\rangle &=
  \frac{1}{a^2} \left\langle
  \mathbf{\nabla}'\times\mathbf{v}_i'\right\rangle =
  \frac{1}{a^2\rho_i'}\sum_j m_j\left(\mathbf{v}_j' -
  \mathbf{v}_i'\right) \times \mathbf{\nabla}_i'W_{ij}'(h_i). \nonumber
\end{align}
We finally give the expressions for the \cite{Monaghan1997} viscosity
term, that enters most SPH flavours, in our system of coordinates. The
viscosity ``tensor'' $\Pi_{ij} \equiv \frac{1}{2}\alpha_{\rm visc} v_{\rm
    sig}'\mu_{ij}/\left(\rho_i + \rho_j\right)$ can be computed
  in the primmed coordinates from the following quantities
\begin{align}
  \omega_{ij}' &= \left(\mathbf{v}_i' - \mathbf{v}_j'\right) \cdot
  \left(\mathbf{r}_i' - \mathbf{r}_j'\right), \\
  \mu_{ij}' &=
  a^{(3\gamma-5)/2} \left(\omega_{ij}' + a^2H\left|\mathbf{r}_i' -
  \mathbf{r}_j'\right|^2 \right) / |\mathbf{r}_i' - \mathbf{r}_j' |,
  \\
  v_{\rm sig}' &= c_i' + c_j' - 3 \mu_{ij}'.
\end{align}
which leads to $\Pi_{ij}'=a^{3\gamma}\Pi_{ij}$. Note that he last quantity is
also used to compute the time-step size. The evolution of entropy is
then
\begin{equation}
  \dot{A}_i = \dot{A}_i' = \frac{1}{a^2}\frac{1}{2}\frac{\gamma-1}{\rho_i'^{\gamma-1}} \sum_j
  m_j \Pi_{ij}' \left(\mathbf{v}_i' -
  \mathbf{v}_j'\right)\cdot\mathbf{\nabla}_i'W_{ij}'(h_i),
\end{equation}
indicating that the entropy evolves with the same scale-factor
dependence as the comoving positions (eq.~\ref{eq:cosmo_eom_r}).
